<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Safe Opear</title>
  <link rel="shortcut icon" href="./src/img/logo.png">
  <link rel="stylesheet" href="./src/css/styles.css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>
</head>

<body>
  <header>
    <img src="./src/img/senai.png" alt="Logo Senai" class="logo-senai" width="200">
    <img src="./src/img/logo.png" alt="Logo Safe Opear" class="logo-safe-opear" width="85">
    <img src="./src/img/pi.webp" alt="Logo Projetos Integradores" class="logo-pi" width="150">
  </header>

  <section>
    <div class="camera"></div>
    <div class="dados">
      <div class="funcionario">
        <h2><span id="nome">NOME</span></h2>
        <br>
        <img src="./src/img/profile.png" alt="Funcionário" id="foto" width="125">
      </div>
      <div class="status">
        <p><span>Curso:</span> <span id="curso">--</span></p>
        <p><span>Validade:</span> <span id="validade">--</span></p>
        <ul>
          <p>EPIs:</p>
          <li><span>Capacete:</span> <span id="capacete">--</span></li>
          <li><span>Óculos:</span> <span id="oculos">--</span></li>
          <li><span>Colete:</span> <span id="colete">--</span></li>
          <li><span>Luvas:</span> <span id="luvas">--</span></li>
        </ul>
      </div>
      <div class="iniciar">
        <button class="botao iniciar" onclick="toggle()" id="btn-toggle">Iniciar Safe Opear</button>
      </div>
    </div>
  </section>

  <section id="mensagem" class="mensagem" style="display:none;">
    <p id="mensagem-texto"></p>
  </section>

  <footer>
    <p>Desenvolvido por Safe Opear - 2025</p>
  </footer>

  <script>
    async function resetDashboard() {
      const nomeElem = document.getElementById("nome");
      const imgElem = document.getElementById("foto");
      nomeElem.innerText = "NOME";
      imgElem.src = "./src/img/profile.png";
      document.getElementById("curso").innerText = "--";
      document.getElementById("validade").innerText = "--";
      document.getElementById("capacete").innerText = "--";
      document.getElementById("oculos").innerText = "--";
      document.getElementById("colete").innerText = "--";
      document.getElementById("luvas").innerText = "--";
    }

    function mostrarMensagem(texto) {
      const msgSection = document.getElementById("mensagem");
      const msgTexto = document.getElementById("mensagem-texto");
      msgTexto.innerText = texto;
      msgSection.style.display = "flex";
      msgSection.classList.remove("fade-out");

      setTimeout(() => {
        msgSection.classList.add("fade-out");
        setTimeout(() => {
          msgSection.style.display = "none";
        }, 500);
      }, 2500);
    }


    async function atualizar() {
      try {
        const res = await fetch('http://localhost:5000/registro');
        const dados = await res.json();
        const statusRes = await fetch('http://localhost:5000/status');
        const statusData = await statusRes.json();
        const statusProcesso = statusData.status;

        const nomeElem = document.getElementById("nome");
        const imgElem = document.getElementById("foto");
        const btn = document.getElementById("btn-toggle");

        if (dados && Object.keys(dados).length > 0) {
          nomeElem.innerText = dados.nome || "NOME";
          imgElem.src = dados.foto ? `./src/img/${dados.foto}` : "./src/img/profile.png";
          document.getElementById("curso").innerText = dados.curso || "--";
          document.getElementById("validade").innerText = dados.validade || "--";
          document.getElementById("capacete").innerText = dados.capacete || "--";
          document.getElementById("oculos").innerText = dados.oculos || "--";
          document.getElementById("colete").innerText = dados.colete || "--";
          document.getElementById("luvas").innerText = dados.luvas || "--";
        } else {
          await resetDashboard();
        }

        if (statusProcesso === "iniciado") {
          btn.innerText = "Parar Safe Opear";
          btn.classList.remove("iniciar");
          btn.classList.add("parar");
        } else {
          btn.innerText = "Iniciar Safe Opear";
          btn.classList.remove("parar");
          btn.classList.add("iniciar");
        }

        if (dados && dados.capacete === "Ok" && dados.oculos === "Ok" && dados.colete === "Ok" && dados.luvas === "Ok") {
          mostrarMensagem(`Funcionário(a) autorizado(a)!`);
        }

      } catch (err) {
        console.error("Erro ao buscar dados:", err);
      }
    }

    async function toggle() {
      try {
        const res = await fetch('http://localhost:5000/toggle');
        const dados = await res.json();
        const btn = document.getElementById("btn-toggle");

        if (dados.status === "iniciado") {
          btn.innerText = "Parar Safe Opear";
          btn.classList.remove("iniciar");
          btn.classList.add("parar");
        } else {
          btn.innerText = "Iniciar Safe Opear";
          btn.classList.remove("parar");
          btn.classList.add("iniciar");
          await resetDashboard();
        }
      } catch (err) {
        mostrarMensagem('Erro ao conectar ao servidor Flask.');
      }
    }

    setInterval(atualizar, 2000);
    atualizar();
  </script>
</body>

</html>